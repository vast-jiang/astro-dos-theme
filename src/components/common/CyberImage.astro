---
// src/components/common/CyberImage.astro

interface Props {
  src: string;
  alt?: string;
  className?: string;
  caption?: string;
}

const { src, alt = "", className = "", caption } = Astro.props as Props;
---

<div
  class={`relative group overflow-hidden border border-dos-dim/60 bg-black/60 ${className}`}
  data-cyber-image
  data-caption={caption || alt}
>
  <img
    src={src}
    alt={alt}
    loading="lazy"
    class="block w-full h-full object-cover transition duration-300 group-hover:scale-[1.03] group-hover:brightness-110"
  />

  <!-- 右下角小角标 -->
  <div
    class="absolute bottom-1 right-1 bg-black/80 text-dos-primary text-[10px] px-1.5 py-0.5 border border-dos-dim/80"
  >
    IMG_VIEW
  </div>

  <!-- 悬停放大提示 -->
  <div
    class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center pointer-events-none"
  >
    <span
      class="text-xs text-dos-primary border border-dos-primary px-3 py-1 bg-black/70"
    >
      [ CLICK TO ZOOM ]
    </span>
  </div>
</div>

{caption && <p class="mt-2 text-xs text-dos-dim font-mono">> {caption}</p>}

<script>
  // @ts-nocheck
  (function () {
    if (typeof window === "undefined") return;

    const OVERLAY_ID = "cyber-image-overlay";

    function ensureOverlay() {
      let overlay = document.getElementById(OVERLAY_ID);
      if (overlay) return overlay;

      overlay = document.createElement("div");
      overlay.id = OVERLAY_ID;
      overlay.className =
        "fixed inset-0 z-[9999] flex items-center justify-center bg-black/90 opacity-0 pointer-events-none transition-opacity duration-200";

      overlay.innerHTML = `
        <div class="relative max-w-5xl max-h-[90vh] w-[90vw] border border-dos-primary bg-black/95 shadow-[0_0_25px_rgba(51,255,0,0.4)] overflow-hidden">
          <button
            type="button"
            data-close
            class="absolute top-2 right-2 z-10 text-[10px] px-2 py-1 border border-dos-dim bg-black/80 text-dos-dim hover:border-dos-primary hover:text-dos-primary"
          >
            [ CLOSE ]
          </button>
          <div class="p-3 border-b border-dos-dim/40 text-xs text-dos-dim flex justify-between items-center">
            <span class="truncate" data-caption>IMAGE_VIEWER</span>
            <span class="text-[10px] uppercase text-dos-dim/70">ESC TO EXIT</span>
          </div>
          <div class="p-3 flex items-center justify-center">
            <img
              data-viewer-image
              class="max-h-[70vh] max-w-full object-contain"
              src=""
              alt=""
            />
          </div>
        </div>
      `;

      document.body.appendChild(overlay);
      return overlay;
    }

    function openViewer(trigger) {
      const overlay = ensureOverlay();
      const img = trigger.querySelector("img");
      if (!img) return;

      const viewerImg = overlay.querySelector("[data-viewer-image]");
      const captionEl = overlay.querySelector("[data-caption]");

      if (viewerImg) {
        viewerImg.src = img.currentSrc || img.src;
        viewerImg.alt = img.alt || "";
      }

      if (captionEl) {
        const c = trigger.getAttribute("data-caption") || img.alt || "IMAGE";
        captionEl.textContent = c;
      }

      overlay.classList.remove("pointer-events-none");
      overlay.classList.remove("opacity-0");
      overlay.classList.add("opacity-100");
    }

    function closeViewer() {
      const overlay = document.getElementById(OVERLAY_ID);
      if (!overlay) return;
      overlay.classList.add("opacity-0");
      overlay.classList.add("pointer-events-none");
      overlay.classList.remove("opacity-100");
    }

    document.addEventListener("astro:page-load", () => {
      const overlay = ensureOverlay();

      // 点击遮罩或 CLOSE 关闭
      overlay.addEventListener("click", (event) => {
        const target = event.target;
        if (
          target === overlay ||
          (target.closest && target.closest("[data-close]"))
        ) {
          event.preventDefault();
          closeViewer();
        }
      });

      // 监听所有带 data-cyber-image 的图片容器
      document.addEventListener("click", (event) => {
        const target = event.target;
        if (!target || !target.closest) return;
        const trigger = target.closest("[data-cyber-image]");
        if (!trigger) return;

        // 阻止可能的 a 链接默认行为，避免页面滚动到顶部
        event.preventDefault();
        event.stopPropagation();
        openViewer(trigger);
      });

      // ESC 关闭
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeViewer();
        }
      });
    });
  })();
</script>
