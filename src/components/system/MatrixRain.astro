---
// src/components/system/MatrixRain.astro
---

<div
  id="matrix-rain-root"
  class="pointer-events-none fixed inset-0 z-[5] mix-blend-screen"
>
  <canvas id="matrix-canvas" class="w-full h-full"></canvas>
</div>

<script>
  // @ts-nocheck
  (function () {
    if (typeof window === "undefined") return;

    const ROOT_ID = "matrix-rain-root";
    const CANVAS_ID = "matrix-canvas";

    /** @type {number[]} */
    let drops = [];
    /** @type {number | null} */
    let animationId = null;
    let isRunning = false;

    function initCanvas() {
      const canvas = document.getElementById(CANVAS_ID);
      const root = document.getElementById(ROOT_ID);
      if (!canvas || !root) return { canvas: null, ctx: null, fontSize: 0 };

      const ctx = canvas.getContext("2d");
      if (!ctx) return { canvas: null, ctx: null, fontSize: 0 };

      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const fontSize = 14;
      const columns = Math.floor(canvas.width / fontSize);
      drops = new Array(columns).fill(1);

      ctx.font = fontSize + "px monospace";

      root.style.opacity = "0";
      root.style.transition = "opacity 0.4s ease-out";
      root.style.pointerEvents = "none";

      return { canvas, ctx, fontSize };
    }

    function startMatrix() {
      const result = initCanvas();
      const canvas = result.canvas;
      const ctx = result.ctx;
      const fontSize = result.fontSize;
      if (!canvas || !ctx || !fontSize) return;

      const root = document.getElementById(ROOT_ID);
      if (root) {
        root.style.opacity = "1";
        root.style.pointerEvents = "none";
      }

      const characters =
        "アァカサタナハマヤャラワガザダバパ0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";

      isRunning = true;

      function draw() {
        if (!isRunning) return;

        ctx.fillStyle = "rgba(0, 0, 0, 0.08)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = "#33ff00";
        for (let i = 0; i < drops.length; i++) {
          const text = characters.charAt(
            Math.floor(Math.random() * characters.length)
          );
          const x = i * fontSize;
          const y = drops[i] * fontSize;

          ctx.fillText(text, x, y);

          if (y > canvas.height && Math.random() > 0.975) {
            drops[i] = 0;
          }
          drops[i]++;
        }

        animationId = window.requestAnimationFrame(draw);
      }

      if (animationId) {
        window.cancelAnimationFrame(animationId);
      }

      animationId = window.requestAnimationFrame(draw);
    }

    function stopMatrix() {
      isRunning = false;
      if (animationId) {
        window.cancelAnimationFrame(animationId);
        animationId = null;
      }

      const canvas = document.getElementById(CANVAS_ID);
      const root = document.getElementById(ROOT_ID);

      if (canvas) {
        const ctx = canvas.getContext("2d");
        if (ctx) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }

      if (root) {
        root.style.opacity = "0";
      }
    }

    document.addEventListener("astro:page-load", () => {
      // 默认关闭，由命令中心通过自定义事件控制
      stopMatrix();

      // CommandCenter 派发：window.dispatchEvent(new CustomEvent("matrix-toggle", { detail: { enabled: true }}))
      window.addEventListener("matrix-toggle", (e) => {
        const enabled = e && e.detail && e.detail.enabled;
        if (enabled) {
          startMatrix();
        } else {
          stopMatrix();
        }
      });

      window.addEventListener("resize", () => {
        if (!isRunning) return;
        startMatrix();
      });
    });
  })();
</script>
